[phases.setup]
# 1. 修正语法：使用 pkgs 而非 nixPkgs
# 2. 强制使用 Node 23 满足 Vite 7 和 Astro 5 要求
nixPkgs = ["nodejs_22"]

[phases.install]
# 安装依赖（包含 edgeone）
cmds = ["npm ci"]

[phases.build]
# 核心逻辑：增加路径诊断 -> 编译 -> 拷贝配置 -> 增量部署
cmds = [
    # --- 诊断步骤：如果构建报错，请看这部分的日志输出 ---
    "echo '--- 检查目录结构 ---'",
    "ls -F src/", 
    "echo '------------------'",
    
    # --- 修复步骤：防止 Git 记录的大小写与 Linux 环境冲突 ---
    # 如果存在 src/Pages，强制重命名为 src/pages
    "if [ -d 'src/Pages' ]; then mv src/Pages src/pages; fi",

    # --- 执行构建 ---
    "npm run build",
    
    # --- 准备上传 ---
    "cp package.json ./dist/",
    
    # --- 增量同步至 EdgeOne ---
    # 删除了 --force，开启 Hash 比对增量模式
    "npx edgeone pages deploy ./dist -n $EDGEONE_PROJECT_NAME -t $EDGEONE_API_TOKEN"
]

[start]
# 启动轻量级监控面板
cmd = "node deploy-wrapper.cjs"